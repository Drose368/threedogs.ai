<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartPA AI åŠ©ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
  <div class="flex h-full">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r flex flex-col p-4">
      <h1 class="text-lg font-semibold mb-6">ğŸ¶ ä¸‰åªç‹— ğŸ¶</h1>
      <button onclick="newChat()" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 mb-2 text-sm">+ æ–°å»ºå¯¹è¯</button>
      <button onclick="clearAllChats()" class="bg-red-100 hover:bg-red-200 text-red-600 rounded px-4 py-2 mb-4 text-sm">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰å¯¹è¯</button>
      <div id="historyList" class="flex-1 overflow-y-auto text-sm space-y-2"></div>
    </aside>

    <!-- Main chat area -->
    <main class="flex-1 flex flex-col">
      <div id="chatBox" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-white"></div>
      <div class="border-t bg-gray-50 p-4">
        <div class="max-w-3xl mx-auto flex flex-col gap-2">
          <select id="task" class="p-2 border rounded text-sm">
            <option value="free_chat">ğŸ•ä¸‰åªç‹—ğŸ•</option>
            <option value="chat_roleplay">å¾¡ç”¨èŠå¤©å¸ˆæ—ç‹—ğŸ•</option>
            <option value="prd">äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰</option>
            <option value="meeting_summary">ä¼šè®®çºªè¦æ€»ç»“</option>
            <option value="glossary">æœ¯è¯­è§£é‡Š</option>
            <option value="user_persona">ç”¨æˆ·ç”»åƒç”Ÿæˆ</option>
            <option value="user_analysis">ç”¨æˆ·éœ€æ±‚åˆ†æ</option>
            <option value="kickoff_plan">é¡¹ç›®å¯åŠ¨è®¡åˆ’</option>
            <option value="competitor_analysis">ç«å“åˆ†ææŠ¥å‘Š</option>
            <option value="swot">SWOTåˆ†æ</option>
            <option value="storyboard">æ•…äº‹æ¿ç”Ÿæˆ</option>
          </select>
          <textarea id="input" rows="2" placeholder="è¯·è¾“å…¥å†…å®¹ï¼ŒEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œ" class="w-full p-3 border rounded resize-none bg-white text-sm"></textarea>
          <div class="flex gap-2">
            <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">å‘é€</button>
            <button id="saveBtn" disabled class="bg-gray-400 text-white px-4 py-2 rounded text-sm cursor-not-allowed">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
  let sessionId = generateId();
  let currentTask = "prd";
  let chatHistory = [];
  let lastReply = "";
  let sessions = JSON.parse(localStorage.getItem("chat_sessions") || "{}");

  const inputEl = document.getElementById("input");
  const chatBox = document.getElementById("chatBox");
  const saveBtn = document.getElementById("saveBtn");
  const historyList = document.getElementById("historyList");

  function generateId() {
    return "sess_" + Date.now();
  }

  function clearAllChats() {
    if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤")) {
      localStorage.removeItem("chat_sessions");
      sessions = {};
      newChat();
    }
  }

  function renderHistoryList() {
    historyList.innerHTML = "";
    Object.keys(sessions).forEach(id => {
      const label = sessions[id].title || "æœªå‘½åå¯¹è¯";
      const container = document.createElement("div");
      container.className = "flex items-center justify-between bg-gray-50 hover:bg-gray-100 px-2 py-1 rounded";

      const btn = document.createElement("button");
      btn.textContent = label.length > 20 ? label.slice(0, 20) + "..." : label;
      btn.className = "text-left flex-1";
      btn.onclick = () => loadSession(id);

      const actions = document.createElement("div");
      actions.className = "flex gap-1";

      const renameBtn = document.createElement("button");
      renameBtn.innerHTML = "âœï¸";
      renameBtn.title = "é‡å‘½å";
      renameBtn.onclick = () => {
        const newTitle = prompt("è¯·è¾“å…¥æ–°åç§°ï¼š", sessions[id].title || "");
        if (newTitle) {
          sessions[id].title = newTitle;
          saveSessions();
          renderHistoryList();
        }
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.innerHTML = "ğŸ—‘ï¸";
      deleteBtn.title = "åˆ é™¤å¯¹è¯";
      deleteBtn.onclick = () => {
        if (confirm("ç¡®å®šåˆ é™¤æ­¤å¯¹è¯ï¼Ÿ")) {
          delete sessions[id];
          saveSessions();
          renderHistoryList();
          if (id === sessionId) newChat();
        }
      };

      actions.append(renameBtn, deleteBtn);
      container.append(btn, actions);
      historyList.appendChild(container);
    });
  }

  function saveSessions() {
    localStorage.setItem("chat_sessions", JSON.stringify(sessions));
  }

  function newChat() {
    sessionId = generateId();
    chatHistory = [];
    lastReply = "";
    saveBtn.disabled = true;
    saveBtn.classList.add("cursor-not-allowed", "bg-gray-400");
    saveBtn.classList.remove("bg-green-600", "hover:bg-green-700");
    sessions[sessionId] = { title: "æ–°å¯¹è¯", history: [] };
    saveSessions();
    renderChat();
    renderHistoryList();
  }

  function loadSession(id) {
    sessionId = id;
    chatHistory = sessions[id].history || [];
    renderChat();
  }

  function renderChat() {
    chatBox.innerHTML = "";
    chatHistory.forEach(item => {
      const div = document.createElement("div");
      div.className = "rounded px-4 py-3 text-sm whitespace-pre-wrap shadow border max-w-3xl mx-auto " +
        (item.role === "user" ? "bg-gray-100 text-right border-gray-200" : "bg-white text-left border-gray-100");
      div.innerHTML = (item.role === "user" ? "<strong></strong> " : "<strong>ğŸ•</strong> ") + item.content;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function appendMessage(role, content) {
    if (!sessions[sessionId]) sessions[sessionId] = { title: "æœªå‘½å", history: [] };
    const msg = { role, content };
    chatHistory.push(msg);
    sessions[sessionId].history = chatHistory;
    if (role === "user" && !sessions[sessionId].title) {
      sessions[sessionId].title = content.slice(0, 20);
    }
    saveSessions();
    renderChat();
  }

  async function sendMessage() {
    const input = inputEl.value.trim();
    currentTask = document.getElementById("task").value;
    if (!input) return alert("â— è¯·è¾“å…¥å†…å®¹");

    appendMessage("user", input);
    inputEl.value = "";
    inputEl.focus();

    appendMessage("assistant", "ğŸ• æ­£åœ¨ç”Ÿæˆä¸­...");

    try {
      const res = await fetch("https://kyrieee1122-tdgsthreedogs.hf.space/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: input,
          task_type: currentTask,
          session_id: sessionId
        })
      });

      const data = await res.json();
      chatHistory.pop();
      if (data.reply) {
        appendMessage("assistant", data.reply);
        lastReply = data.reply;
        saveBtn.disabled = false;
        saveBtn.classList.remove("cursor-not-allowed", "bg-gray-400");
        saveBtn.classList.add("bg-green-600", "hover:bg-green-700");
      } else {
        appendMessage("assistant", "âŒ AI å›å¤å¤±è´¥");
      }
    } catch (err) {
      chatHistory.pop();
      appendMessage("assistant", "âŒ ç½‘ç»œé”™è¯¯ï¼š" + err.message);
    }
  }

  saveBtn.addEventListener("click", async () => {
    if (!lastReply) return;
    try {
      const res = await fetch("https://kyrieee1122-tdgsthreedogs.hf.space/api/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: lastReply,
          task_type: currentTask,
          session_id: sessionId
        })
      });

      const data = await res.json();
      if (data.file_url) {
        window.open("https://kyrieee1122-tdgsthreedogs.hf.space" + data.file_url, "_blank");
      } else {
        alert("âŒ ä¿å­˜å¤±è´¥");
      }
    } catch (err) {
      alert("âŒ è¯·æ±‚å‡ºé”™ï¼š" + err.message);
    }
  });

  inputEl.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  renderHistoryList();
  newChat();  // åˆå§‹åŒ–
</script>
</body>
</html>
